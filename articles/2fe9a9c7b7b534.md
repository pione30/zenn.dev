---
title: "Jestã§URL.createObjectURLã¨loadã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹"
emoji: "ğŸ–¼ï¸"
type: "tech"
topics: ["web", "jest"]
published: true
---

ã“ã†ã„ã†`imageSize()`é–¢æ•°ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã„ã¨æ€ã„ã¾ã™:

```ts:imageSize.ts
type Size = {
  width: number;
  height: number;
};

const imageSize = (file: File): Promise<Size> => {
  return new Promise((resolve, reject) => {
    const img = document.createElement("img");

    img.onload = () => {
      resolve({
        width: img.width,
        height: img.height,
      });
    };

    img.src = URL.createObjectURL(file);
  });
};

export default imageSize;
```

ã“ã“ã§`URL.createObjectURL`ã¨`load`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ¢ãƒƒã‚¯ã—ã‚ˆã†ã¨ã—ã¦å°‘ã—ãƒãƒã£ãŸã®ã§è¨˜éŒ²ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚

Jestã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯27.3.1ã€`jest.config.js`ã¯

```js:jest.config.js
module.exports = {
  testEnvironment: "jsdom",
};
```

ã¨ã„ã†ç’°å¢ƒã§ã™ã€‚

### `URL.createObjectURL`

Jest 27.3.1ã®æ™‚ç‚¹ã§ä¾å­˜ã§å…¥ã‚‹`jsdom`ã¯`URL.createObjectURL`ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã›ã‚“[^jsdom-create-object-url]ã€‚

ãªã®ã§ä½•ã‚‚ãƒ¢ãƒƒã‚¯ã›ãšã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚Œã°

> TypeError: URL.createObjectURL is not a function

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã—ã€ãã‚‚ãã‚‚`URL.createObjectURL`ãŒå­˜åœ¨ã—ãªã„ã®ã§

```ts
jest.spyOn(URL, "createObjectURL").mockImplementation(() => "");
```

ã®ã‚ˆã†ã«`jest.spyOn()`ã—ã‚ˆã†ã¨ã—ã¦ã‚‚

> Cannot spy the createObjectURL property because it is not a function; undefined given instead

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ãªã®ã§ç›´æ¥`jest.fn()`ã‚’ä»£å…¥ã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

```ts:imageSize.test.ts
beforeEach(() => {
  URL.createObjectURL = jest.fn();
});

afterEach(() => {
  // @ts-ignore: URL.createObjectURL is mocked within beforeEach()
  URL.createObjectURL.mockReset();
});
```

### `load`ã‚¤ãƒ™ãƒ³ãƒˆ

`URL.createObjectURL`ã‚’ãƒ¢ãƒƒã‚¯ã—ãŸã®ã§å½“ç„¶ãªãŒã‚‰ç”»åƒã®`load`ã‚¤ãƒ™ãƒ³ãƒˆã¯ç™ºç«ã—ã¾ã›ã‚“ã€‚
ãã“ã§`document.createElement`ã‚’ãƒ¢ãƒƒã‚¯ã—ã¦ã€ä¸€å®šæ™‚é–“å¾Œã«`dispatchEvent()`ã™ã‚‹ã“ã¨ã§æ“¬ä¼¼çš„ã«`load`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™:

```ts:imageSize.test.ts
beforeEach(() => {
  // å…ˆã«å…ƒã€…ã®å®Ÿè£…ã®document.createElement()ã‚’ä½¿ã£ã¦imageElementã‚’ä½œã£ã¦ãŠã
  const imageElement = document.createElement("img");

  jest.spyOn(document, "createElement").mockImplementation(() => {
    setTimeout(() => {
      imageElement.dispatchEvent(new Event("load"));
    }, 50);

    return imageElement;
  });
});

afterEach(() => {
  jest.restoreAllMocks();
});
```

ã•ã‚‰ã«`width`ã‚„`height`ã¨ã„ã£ãŸattributeã‚’è¨­å®šã—ã¦ãŠãã“ã¨ã§ã€ãã®å€¤ã‚’ãƒ†ã‚¹ãƒˆæœ¬ä½“ã§ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™:

```diff ts:imageSize.test.ts
   const imageElement = document.createElement("img");
   
   jest.spyOn(document, "createElement").mockImplementation(() => {
+    imageElement.setAttribute("width", "640");
+    imageElement.setAttribute("height", "480");
+
     setTimeout(() => {
       imageElement.dispatchEvent(new Event("load"));
     }, 50);
```

## ã¾ã¨ã‚

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å…¨ä½“ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸ:

```ts:imageSize.test.ts
import imageSize from "./imageSize";

describe("imageSize", () => {
  const mockedImageWidth = 640;
  const mockedImageHeight = 480;

  beforeEach(() => {
    URL.createObjectURL = jest.fn();

    // å…ˆã«å…ƒã€…ã®å®Ÿè£…ã®document.createElement()ã‚’ä½¿ã£ã¦imageElementã‚’ä½œã£ã¦ãŠã
    const imageElement = document.createElement("img");

    jest.spyOn(document, "createElement").mockImplementation(() => {
      imageElement.setAttribute("width", mockedImageWidth.toString());
      imageElement.setAttribute("height", mockedImageHeight.toString());

      setTimeout(() => {
        imageElement.dispatchEvent(new Event("load"));
      }, 50);

      return imageElement;
    });
  });

  afterEach(() => {
    // @ts-ignore: URL.createObjectURL is mocked within beforeEach()
    URL.createObjectURL.mockReset();
    jest.restoreAllMocks();
  });

  it("ç”»åƒã®widthã¨heightãŒè¿”ã‚‹", async () => {
    const pngFile = new File([""], "test.png");

    const size = await imageSize(pngFile);
    expect(size).toEqual({
      width: mockedImageWidth,
      height: mockedImageHeight,
    });
  });
});
```

ã“ã‚Œã§ã‚ã§ãŸããƒ†ã‚¹ãƒˆã¯å‹•ãã€æ­£å¸¸ã«ãƒ‘ã‚¹ã—ã¾ã™ã€‚

[^jsdom-create-object-url]: https://github.com/jsdom/jsdom/issues/1721
