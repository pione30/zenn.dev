---
title: "GitHub Composite Actionsã§GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ¼"
type: "tech"
topics: ["git", "githubactions"]
published: true
---

### Composite Action

GitHub Actionsã‚’è‡ªä½œã™ã‚‹éš›ã¯Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã†æ–¹æ³•[^creating-a-docker-container-action]ã‚„Node.jsã§æ›¸ãæ–¹æ³•[^https://docs.github.com/ja/actions/creating-actions/creating-a-javascript-action]ãŒã‚ã‚Šã¾ã™ãŒã€ç¬¬ä¸‰ã®æ–¹æ³•ã¨ã—ã¦ã‚¸ãƒ§ãƒ–ã®`steps`ã®ä¸€éƒ¨ã‚’åˆ‡ã‚Šå‡ºã™ã‚ˆã†ãªå½¢å¼ã§æ›¸ãã“ã¨ã‚‚ã§ãã¦ã€ãã‚Œã«ã¯Composite Actionã¨ã„ã†åå‰ãŒä»˜ã„ã¦ã„ã¾ã™:

https://docs.github.com/ja/actions/creating-actions/creating-a-composite-action

Composite Actionã‚’ä½œæˆã™ã‚‹ã¨ãã®`action.yml`ã®æ§‹æ–‡ã¯Dockerã‚„JavaScriptã®å ´åˆã¨ã»ã¼åŒã˜ã§ã™ãŒã€ç‰¹å¾´çš„ãªã®ã¯

- `runs.using`ã«`"composite"`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨
- `runs.steps[*].run`ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã€ä½¿ã„ãŸã„ã‚·ã‚§ãƒ«ã®ç¨®é¡ã‚’`runs.steps[*].shell`ã§å¿…ãšæŒ‡å®šã™ã‚‹ã“ã¨

ã§ã—ã‚‡ã†ã‹ã€‚

ï¼ˆ`action.yml`ã«ã¤ã„ã¦ã®è©³ç´°ã¯[ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://docs.github.com/ja/actions/creating-actions/metadata-syntax-for-github-actions#runs-for-composite-actions)ã‚’ã”è¦§ãã ã•ã„ï¼‰

åˆ©ç”¨ã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ãŒç’°å¢ƒå†…ã«å­˜åœ¨ã™ã‚‹ã“ã¨ãŒä»®å®šã§ãã¦`run`ã®é€æ¬¡å®Ÿè¡Œã ã‘ã§æ¸ˆã‚€ã‚ˆã†ãªå‡¦ç†ã‚’å…±é€šåŒ–ã—ã¦è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ä½¿ã„å›ã—ãŸã„ã€ã¨ã„ã†æ™‚ã«Composite Actionã‚’ä½¿ãˆã°æ°—è»½ã«GitHub Actionã‚’ä½œã‚Œã¦ä¾¿åˆ©ãã†ã§ã™ã€‚

ç§ã¯Composite Actionã®å­˜åœ¨ã‚’æœ€è¿‘çŸ¥ã£ãŸã®ã§ã€ä½•ã‹ç°¡å˜ãªãŠé¡Œã§ç·´ç¿’ã—ã¦ã¿ã‚‹ã‹ã¨æ€ã„ã€æ‰‹å§‹ã‚ã«æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ç‰©ã‚’GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹Composite Actionã‚’ä½œã£ã¦ã¿ã¾ã—ãŸ:

<https://github.com/pione30/github-pages-deploy-composite-action>

2021å¹´10æœˆç¾åœ¨ã®GitHub-hostedãªrunnerã®ç’°å¢ƒã§ã¯`ubuntu-latest`ã€`windows-latest`ã€`macos-latest`ã¨ã‚‚ã«GitãŒä½¿ãˆã‚‹[^Ubuntu2004-README.md#tools][^Windows2019-Readme.md#tools][^macos-10.15-Readme.md#utilities]ã®ã§å°‘ãªãã¨ã‚‚ãã®ç’°å¢ƒã§ã¯å‹•ãã ã‚ã†ã¨æ€ã„ã¾ã™ã€‚

å†…å®¹ã¨ã—ã¦ã¯æœ¬å½“ã«naiveãªæ“ä½œã—ã‹è¡Œã£ã¦ã„ãªã„ç°¡å˜ãªã‚‚ã®ãªã®ã§ã™ãŒã€ãã‚Œã§ã‚‚å€‹äººçš„ã«ã¯ãã‚Œã¾ã§çŸ¥ã‚‰ãªã‹ã£ãŸGitã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ãŸã‚Šã—ãŸã®ã§ã“ã“ã«è¨˜éŒ²ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚

### `git switch --orphan <new-branch>`

https://git-scm.com/docs/git-switch/2.33.0#Documentation/git-switch.txt---orphanltnew-branchgt

ã“ã®actionã‚’åˆã‚ã¦å®Ÿè¡Œã—ãŸã¨ããªã©ã€ã¾ã ãƒªãƒã‚¸ãƒˆãƒªã«GitHub Pagesç”¨ã®ãƒ–ãƒ©ãƒ³ãƒï¼ˆ`gh-pages`ã¨ã‹ï¼‰ãŒå­˜åœ¨ã—ã¦ã„ãªã‹ã£ãŸå ´åˆã«ã¯æ–°ã—ãã¾ã£ã•ã‚‰ãªãƒ–ãƒ©ãƒ³ãƒã‚’actionå†…ã§è‡ªå‹•ã§ä½œæˆã—ã¦ã‚ã’ãŸã„ã‚ã‘ã§ã™ãŒã€ãã‚Œã£ã¦ç°¡å˜ã«ã§ãã‚‹ã®ã‹ãªã¨æ€ã£ã¦èª¿ã¹ãŸã‚‰è¦‹ã¤ã‘ã¾ã—ãŸã€‚ã“ã®`--orphan`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦`git switch`ã™ã‚‹ã¨ã€ä»Šã¾ã§ã®å±¥æ­´ã¨ã¯å…¨ãç„¡é–¢ä¿‚ãªã€ã¾ã‚‹ã§ä»Š`git init`ã—ãŸã°ã‹ã‚Šã§ã‚ã‚‹ã‹ã®ã‚ˆã†ãªãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¡ãªã¿ã«ä¸Šè¨˜ã®ã‚ˆã†ã«ã—ã¦ä½œæˆã—ãŸãƒ–ãƒ©ãƒ³ãƒãŒãƒªãƒã‚¸ãƒˆãƒªã«å­˜åœ¨ã™ã‚‹å ´åˆã€ãã®ãƒ–ãƒ©ãƒ³ãƒã‚’æ™®é€šã«`git pull`ã—ã‚ˆã†ã¨ã™ã‚‹ã¨

```
fatal: refusing to merge unrelated histories
Error: Process completed with exit code 128.
```

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã—ã‹ã—è‡ªåˆ†ã¯ãã‚“ãªãƒ–ãƒ©ãƒ³ãƒã§ã‚‚ç¢ºã‹ãªæ„æ€ã‚’ã‚‚ã£ã¦pullã—ãŸã„ã‚“ã ã€ã¨ã„ã†ã¨ãã«ã¯`--allow-unrelated-histories`ã¨ã„ã†è¦‹æ…£ã‚Œãªã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦`git pull --allow-unrelated-histories origin gh-pages`ã®ã‚ˆã†ã«ã—ã¦ã‚ã’ã‚Œã°pullã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:

https://git-scm.com/docs/git-pull/2.33.0#Documentation/git-pull.txt---allow-unrelated-histories

### `git diff --quiet`

https://git-scm.com/docs/git-diff/2.33.0#Documentation/git-diff.txt---quiet

Actionã‚’å®Ÿè¡Œã—ãŸçµæœã€å¯¾è±¡ã¨ãªã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½•ã‚‚å¤‰æ›´ãŒç„¡ã‹ã£ãŸå ´åˆã¯commitã™ã¹ãå¤‰æ›´ã‚‚ç„¡ã„ã‚ã‘ã§ã™ãŒã€ãã‚“ãªcleanãªçŠ¶æ…‹ã§`git commit`ã™ã‚‹ã¨

```
nothing to commit, working tree clean
```

ã¨è¡¨ç¤ºã•ã‚Œã¤ã¤çµ‚äº†ã‚³ãƒ¼ãƒ‰ãŒ1ã¨ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚ãªã®ã§å¤‰æ›´ãŒç„¡ã‘ã‚Œã°ãã®æ™‚ç‚¹ã§çµ‚äº†ã‚³ãƒ¼ãƒ‰0ã§ã‚³ãƒãƒ³ãƒ‰ã‚’çµ‚ã‚ã‚‰ã›ã¦ã€å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿`git commit`ã‚„`git push`ã«é€²ã‚€ã‚ˆã†ã«ã—ãŸã„ã§ã™ã­ã€‚

ãã“ã§ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’èª­ã‚“ã§ã¿ã‚‹ã¨ã€`git diff`ã«ã¯`--exit-code`[^git-diff.txt---exit-code]ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚ã“ã‚Œã¯ä½•ã‚‰ã‹ã®å¤‰æ›´ãŒã‚ã‚Œã°çµ‚äº†ã‚³ãƒ¼ãƒ‰1ã§ã€å¤‰æ›´ãŒç„¡ã‘ã‚Œã°çµ‚äº†ã‚³ãƒ¼ãƒ‰0ã§ã‚³ãƒãƒ³ãƒ‰ã‚’çµ‚äº†ã•ã›ã‚‹ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚
ãã—ã¦GitHub Actionsä¸Šã§ã¯diffã®å†…å®¹ã‚’ã‚ã–ã‚ã–è¡¨ç¤ºã•ã›ã‚‹å¿…è¦ã¯ãªã„ã®ã§`--quiet`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ãŸããªã‚Šã¾ã™ãŒã€ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’è¦‹ã‚‹ã¨`--quiet`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯

> Implies `--exit-code`

ã§ã‚ã‚‹ã‚ˆã†ã§ã€ã¾ã•ã«ã´ã£ãŸã‚Šãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦

```bash
git diff --cached --quiet \
|| git commit -m 'Deploy to GitHub Pages' \
&& git push origin ${{ inputs.branch }}
```

ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

### ã¾ã¨ã‚

* åŸºæœ¬çš„ãªã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚„ã‚³ãƒãƒ³ãƒ‰ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œã ã‘ã§æ¸ˆã‚€ã‚ˆã†ãªå‡¦ç†ã‚’GitHub Actionsã«ã—ãŸã„ã¨ãã¯Composite Actionã‚’è©¦ã—ã¦ã¿ã‚‹ã¨ã‚ˆã•ãã†
* Gitã«ã¯ä¾¿åˆ©ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè‰²ã€…ã‚ã‚Šã¾ã™

[^creating-a-docker-container-action]: https://docs.github.com/ja/actions/creating-actions/creating-a-docker-container-action

[^https://docs.github.com/ja/actions/creating-actions/creating-a-javascript-action]: https://docs.github.com/ja/actions/creating-actions/creating-a-javascript-action

[^Ubuntu2004-README.md#tools]: https://github.com/actions/virtual-environments/blob/ubuntu20/20210929.1/images/linux/Ubuntu2004-README.md#tools

[^Windows2019-Readme.md#tools]: https://github.com/actions/virtual-environments/blob/win19/20210928.2/images/win/Windows2019-Readme.md#tools

[^macos-10.15-Readme.md#utilities]: https://github.com/actions/virtual-environments/blob/macos-10.15/20201003.1/images/macos/macos-10.15-Readme.md#utilities

[^git-diff.txt---exit-code]: https://git-scm.com/docs/git-diff/2.33.0#Documentation/git-diff.txt---exit-code